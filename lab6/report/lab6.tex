\include{settings}

\begin{document}

\include{titlepage}

\tableofcontents
\newpage

\section{Цели работы}

Познакомиться с возможностями реализации более сложной обработки данных на стороне сервера с помощью хранимых процедур и триггеров.

\section{Программа работы}

\begin{enumerate}
	\item Создание двух триггеров: один триггер для автоматического заполнения ключевого поля, второй триггер для контроля целостности данных в подчиненной таблице при удалении/изменении записей в главной таблице.
	\item Создание триггера в соответствии с индивидуальным заданием, полученным у преподавателя.
	\item Создание триггера в соответствии с индивидуальным заданием, вызывающего хранимую процедуру.
\end{enumerate}
 
\section{Триггер для автоматического заполнения ключевого поля}

В листинге \ref{lst:pk-trigger.sql} представлен триггер, автоматически заполняющий поле с первичным ключом при добавлении записи в таблицу \code{language}, а также продемонстрирована его работа.

\lstinputlisting[caption={pk-trigger.sql},label={lst:pk-trigger.sql}]{pk-trigger.sql}

 
\section{Триггер для контроля целостности данных}

В листинге \ref{lst:fk-consistency-trigger.sql} представлен триггер, который позволяет поддерживать целостность данных в подчиненной таблице при удалении записей в главной таблице.

\lstinputlisting[caption={fk-consistency-trigger.sql},label={lst:fk-consistency-trigger.sql}]{fk-consistency-trigger.sql}

После удаления записи из таблицы \code{player}, первичный ключ которой является внешним ключом для таблицы \code{team}, также удаляется соответствующая запись из таблицы \code{team}.

\section{Триггер, вызывающий ХП при добавлении новой подписки пользователю}

\paragraph{Задание:} При добавлении новой подписки пользователю вызвать процедуру, которая на основании данных о подписках пользователя и о популярности фильмов по категориям формирует список предложений для заданного пользователя. Данная процедура \\\code{up\_to\_n\_movie\_recommendations\_for\_user(n SMALLINT, user\_id BIGINT)} была разработана в рамках предыдущей лабораторной работы.

\lstinputlisting[caption={new-subscription-trigger.sql},label={lst:new-subscription-trigger.sql}]{new-subscription-trigger.sql}

\section{Триггер, реализующий проверку на дубли при добавлении или изменении подписок}

\paragraph{Задание:} Реализовать проверку на дубли при добавлении или изменении подписок. В случае дубля выбрасывать исключение.

\lstinputlisting[caption={check-for-duplicates.sql},label={lst:check-for-duplicates.sql}]{check-for-duplicates.sql}

Проверка на дубли осуществляется следующим образом. При добавлении в таблицу \code{subscription\_series\_season} новой пары <<подписка -- сезон сериала>> происходит проверка всех подписок данного пользователя на наличие данного сезона сериала.

\section{Выводы}

В результате работы был изучен принцип работы триггеров, а также синтаксис, который позволяет их создавать, и затем было создано несколько триггеров, срабатывающих при добавлении, обновлении или удалении записей, удовлетворяющих определенным условиям для определенных таблиц.

\end{document}
